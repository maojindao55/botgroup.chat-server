# 微信公众号扫码登录开发任务清单

## 项目概述
基于微信公众号关注事件的扫码登录功能，用户扫码关注后自动登录。

## 📝 开发任务清单

### 🏗️ 基础设施 (先搞定这些)

#### 1. 数据库设计 ✅
- [x] 创建 `wechat_users` 表
- [x] 设计 Redis 缓存结构 (`wechat_login:session:{session_id}`)
- [x] 写个简单的迁移脚本
- [x] 加上必要的索引

#### 2. 配置管理 ✅
- [x] 扩展 `config.go` 添加微信配置
- [x] 添加 WebSocket 配置
- [x] 更新 `config.yaml` 模板
- [x] 搞个 `.env` 示例文件

#### 3. 基础模型 ✅
- [x] 创建 `WechatUser` 模型
- [x] 定义 `LoginSession` 结构
- [x] 加上基本的验证方法

### ⚙️ 核心服务 (重头戏)

#### 4. 微信二维码服务
- [ ] 写个 `WechatQRService`，调用微信API生成临时二维码
- [ ] 生成唯一的场景值 (qr_scene)
- [ ] 处理二维码过期逻辑

#### 5. 微信事件回调服务
- [ ] 搞个 `WechatCallbackService` 处理微信的XML回调
- [ ] 解析关注事件，提取 openid 和场景值
- [ ] 自动回复消息给用户

#### 6. WebSocket服务
- [ ] 实现 `WebSocketService` 管理连接
- [ ] 消息推送功能
- [ ] 连接池管理

#### 7. 会话管理
- [ ] `SessionService` 操作Redis缓存
- [ ] 会话过期清理
- [ ] 状态转换管理

#### 8. 用户认证扩展
- [ ] 扩展现有 `UserService`
- [ ] 微信用户注册/登录逻辑
- [ ] JWT生成 (保持与现有系统兼容)

### 🗄️ 数据层

#### 9. 数据仓库
- [ ] `WechatUserRepository` - 微信用户CRUD
- [ ] `SessionRepository` - Redis操作封装
- [ ] 优化查询性能

#### 10. 中间件
- [ ] 微信签名验证中间件
- [ ] API限流中间件
- [ ] 请求日志中间件

### 🌐 API接口 (对外的门面)

#### 11. 二维码生成接口
- [ ] `POST /api/auth/wechat/qr-code`
- [ ] 参数验证和错误处理

#### 12. 微信回调接口
- [ ] `GET /api/auth/wechat/callback` (服务器验证)
- [ ] `POST /api/auth/wechat/callback` (事件处理)

#### 13. WebSocket接口
- [ ] `/ws/auth/{session_id}` 端点
- [ ] 连接建立和消息推送

### 🔐 安全相关

#### 14. 微信签名验证
- [ ] 服务器配置验证
- [ ] 消息签名校验
- [ ] 防重放攻击

#### 15. 错误处理
- [ ] 统一错误响应格式
- [ ] 详细错误日志
- [ ] 优雅错误恢复

### 🧪 测试 (别偷懒)

#### 16. 单元测试
- [ ] 服务层测试 (争取90%+覆盖率)
- [ ] Mock对象测试
- [ ] 工具函数测试

#### 17. 集成测试
- [ ] API接口测试
- [ ] 数据库操作测试
- [ ] Redis缓存测试

#### 18. 端到端测试
- [ ] 完整登录流程测试
- [ ] WebSocket连接测试
- [ ] 异常情况测试

### 🚀 部署上线

#### 19. 部署配置
- [ ] 生产环境配置
- [ ] 微信公众号配置
- [ ] HTTPS域名配置

#### 20. 监控日志
- [ ] 关键指标监控
- [ ] 日志记录完善
- [ ] 告警机制

## 📋 我的开发笔记

### 进度记录
- [ ] 基础设施搭建 (任务1-3)
- [ ] 核心服务开发 (任务4-8) 
- [ ] 数据层实现 (任务9-10)
- [ ] API接口开发 (任务11-13)
- [ ] 安全和测试 (任务14-18)
- [ ] 部署上线 (任务19-20)

### 开发顺序
1. 先搞定数据库和配置 (任务1-2)
2. 然后是模型层 (任务3)
3. 核心服务一个个实现 (任务4-8)
4. 接口层开发 (任务11-13)
5. 安全和测试 (任务14-18)
6. 最后部署 (任务19-20)

### 注意事项
- 微信公众号必须已认证
- 回调接口必须HTTPS
- 不能影响现有手机号登录
- Redis缓存要考虑过期清理
- WebSocket连接要处理断线重连

### 预计耗时
大概20天左右能搞定，关键看微信API对接和WebSocket实现会不会踩坑。