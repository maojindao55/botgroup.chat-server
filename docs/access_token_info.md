# 微信 Access Token 缓存机制说明

## Access Token 特性

### 1. 有效期
- **官方有效期**: 2小时（7200秒）
- **缓存有效期**: 1小时55分钟（6900秒）
- **提前刷新**: 剩余5分钟时自动刷新

### 2. 缓存策略
- **存储位置**: Redis缓存
- **缓存键**: `wechat:access_token`
- **缓存内容**: 
  ```json
  {
    "access_token": "实际的token值",
    "expires_at": "2024-01-01 12:00:00"
  }
  ```

### 3. 刷新机制
- **自动刷新**: 当缓存中token剩余时间少于5分钟时自动刷新
- **手动刷新**: 通过调试接口可以强制刷新
- **错误处理**: 如果获取失败，会返回详细错误信息

## 调试接口

### 查看Token状态
```
GET /api/auth/wechat/debug/token
```

**响应示例:**
```json
{
  "success": true,
  "message": "Token状态查询成功",
  "data": {
    "cached": true,
    "valid": true,
    "access_token": "wx12345678...",
    "expires_in": 3456,
    "expires_at": "2024-01-01 12:00:00"
  }
}
```

### 状态说明
- `cached`: 是否已缓存
- `valid`: 是否有效
- `access_token`: token前10位（安全考虑）
- `expires_in`: 剩余有效时间（秒）
- `expires_at`: 过期时间

## 性能优化

### 1. 减少API调用
- 缓存有效期内不会重复调用微信API
- 大幅减少对微信服务器的请求次数

### 2. 提高响应速度
- 缓存命中时响应时间 < 1ms
- 避免网络延迟和API调用开销

### 3. 避免频率限制
- 微信API有调用频率限制
- 缓存机制有效避免触发限制

## 监控建议

### 1. 定期检查Token状态
```bash
# 每5分钟检查一次
curl http://localhost:8080/api/auth/wechat/debug/token
```

### 2. 监控缓存命中率
- 高命中率表示缓存工作正常
- 低命中率可能需要调整缓存策略

### 3. 错误监控
- 监控Token获取失败的情况
- 及时处理微信API异常

## 故障排除

### 1. Token获取失败
**可能原因:**
- 微信公众号配置错误
- 网络连接问题
- 微信API服务异常

**解决方案:**
- 检查AppID和AppSecret配置
- 检查网络连接
- 查看微信API状态

### 2. 缓存异常
**可能原因:**
- Redis连接失败
- 缓存数据格式错误

**解决方案:**
- 检查Redis服务状态
- 清除缓存重新获取

### 3. Token过期
**正常现象:**
- Token每2小时自动过期
- 系统会自动刷新

**异常情况:**
- 如果频繁过期，检查系统时间
- 如果刷新失败，检查微信配置

## 安全注意事项

1. **Token保密**: Access Token具有较高权限，不要泄露
2. **调试接口**: 仅开发环境可用，生产环境会自动禁用
3. **日志记录**: 避免在日志中记录完整Token
4. **访问控制**: 调试接口有IP限制和环境检查 